Validation Report — MARP Billing Engine (synthetic)

Summary:
- This report documents validations expected from the simulated flow (signup → usage → discount → renewal → cancellation).
- Note: simulation was not executed in this environment; the checks below are derived from the deterministic design and the simulation script in `src/simulate.ts`.

Checks (expected passing):
1) No double charging
   - Idempotency keys are required for operations. Orchestrator checks existing ledger entries by `idempotencyKey` before charging.
2) No retroactive discounts
   - Policies include `effective_from` and are selected based on charge time. Discounts are stamped in ledger entries.
3) No negative balances
   - `WalletService.debit` throws on insufficient funds and sets `status` to `locked` at zero; auto-top-up is opt-in only.
4) Policy provenance
   - Every ledger entry includes `policyId` and `policyVersion` fields when a policy applies.
5) Audit integrity
   - `LedgerService` computes `entryHash` (SHA-256) of canonical entry JSON and stores `prevHash` chain; reconciliation computes and stores Merkle roots.

Manual run instructions (to fully validate with live outputs):
1. Install and build:
   cd packages/billing-engine
   pnpm install
   pnpm run build
2. Run migrations (optional, if DATABASE_URL set):
   pnpm migrate
3. Run simulation:
   node dist/simulate.js
   - This writes `data/billing/ledger_export.json` and `data/billing/design_summary.txt` in the package folder.
4. Run reconciliation (if Postgres used and ledger populated):
   pnpm reconcile

If you want, I can run these steps for you if you provide `DATABASE_URL` (for DB-backed run) or confirm it's OK to run local simulation using JSON files. 
